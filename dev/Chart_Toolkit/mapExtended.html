<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  
    <title>National Older Worker Indicator</title>
    <link type="text/css" rel="stylesheet" href="css/ex.css">
    <link type="text/css" rel="stylesheet" href="css/jquery-ui-1.css">
 
    <script type="text/javascript" src="js/protovis.js"></script>
    <script type="text/javascript" src="js/jquery-1.js"></script>

    <script type="text/javascript" src="js/jquery-ui-1.js"></script>
    <script type="text/javascript" src="js/centroid.js"></script>
    <script type="text/javascript" src="js/statelist_lowres.js"></script>
    <script type="text/javascript" src="js/us_lowres.js"></script>
    <script type="text/javascript" src="js/olderWorkerStatistics.js"></script>
    <script type="text/javascript" src="js/protoSlider.js"></script>
    <script type="text/javascript" src="js/protoSliderMap2.js"></script>
    <!--<script type="text/javascript" src="js/protoSliderLoader.js"></script>-->
    <script type="text/javascript" src="js/xml2json.js"></script>
    <script type="text/javascript" src="js/state_size.js"></script>
    <script type="text/javascript" src="js/geo_codes.js"></script>
    <script type="text/javascript" src="js/naics2_codes.js"></script>
    <!--<script type="text/javascript" src="states/RI.js"></script>-->

<script type="text/javascript">

//jQuery.support.cors = true; // force cross-site scripting (as of jQuery 1.5)
// Perform GeoCodes test
//alert('GeoCode ' + GeoCodes['13001']);

function parseData(dsJsonObj){
	//console.log(dsJsonObj);
	console.log('Inside parseData');
	console.log(dsJsonObj.EmpByAgegrpSex[0]);
}

// XML to JSON
function myXMLtoJSON(url,params){
	$.ajax({
		type: "GET",
		url: url,
		dataType: "xml",
		complete: function(xml) {
			window['dsJsonObj'] = $.xml2json(xml);
			$.get(url, function(xml){
				var dsJsonObj = $.xml2json(xml);
				parseData(dsJsonObj);
			});
		}
	});
}

var url = 'http://localhost/workerprofiles/visualization/xml_files/EmpByAgegrp2000Q2.xml';
myXMLtoJSON(url,params=[]);

var datOString = '{"2008":{"AL":-0.59,"AK":-1.96,"AZ":-1.13,"AR":-0.11,"CA":-1.18,"CO":-0.93,"CT":2.31,"DE":0.8,"DC":0,"FL":1.34,"GA":-1.72,"HI":1.3,"ID":-0.79,"IL":0.21,"IN":0.62,"IA":1.3,"KS":0.58,"KY":-1.34,"LA":-0.99,"ME":2.89,"MD":0.67,"MA":0,"MI":-0.41,"MN":-0.61,"MS":-0.63,"MO":-0.22,"MT":1.88,"NE":0.74,"NV":0.32,"NH":0,"NJ":2.07,"NM":0.54,"NY":0.62,"NC":-0.07,"ND":0.22,"OH":0.83,"OK":0.21,"OR":1.25,"PA":1.85,"RI":1.6,"SC":0.65,"SD":1.02,"TN":0.15,"TX":-1.62,"UT":-3.7,"VT":3.28,"VA":0.2,"WA":-0.28,"WV":1.01,"WI":0.35,"WY":0.47},"2009":{"AL":-0.55,"AK":-1.91,"AZ":-1.04,"AR":-0.2,"CA":-1.22,"CO":-0.67,"CT":2.27,"DE":0.22,"DC":0,"FL":1.2,"GA":-1.79,"HI":1.42,"ID":-0.75,"IL":0.2,"IN":0.72,"IA":1.27,"KS":0.72,"KY":-1.41,"LA":-1.12,"ME":3.02,"MD":0.68,"MA":0,"MI":-0.46,"MN":-0.65,"MS":-0.52,"MO":-0.35,"MT":2.21,"NE":0.91,"NV":0.15,"NH":0,"NJ":1.98,"NM":0.45,"NY":0,"NC":-0.15,"ND":0.3,"OH":0.86,"OK":0.28,"OR":1.42,"PA":3.04,"RI":1.51,"SC":0.49,"SD":1.11,"TN":0.19,"TX":-1.65,"UT":-3.68,"VT":3.54,"VA":0.19,"WA":0.14,"WV":1.19,"WI":0.39,"WY":0.92}}';
var stateData = jQuery.parseJSON(datOString);

//create new state data including quarters


// remove json extensions since they mess everything up
if(Object.toJSONString){ 
	delete Object.prototype.toJSONString;
	delete String.prototype.toJSONString;
}
if(Object.parseJSON){ 
	delete Object.prototype.parseJSON;
	delete String.prototype.parseJSON;
}

// generate extra years
var extrayears = 7;
if(extrayears > 0){
	//add more years to the test data
	//var extrayears = 2;
	var curyear = 2007;
	while(curyear >= 2008-extrayears){
		stateData[curyear] = new Object;
		for(state in stateData[2008]){
			if(state.length ==2){
				stateData[curyear][state] = (Math.random()*100);
			}
		}
		curyear -= 1;
	}
}
var stateDataQ = new Object();
for(var y in stateData){
  stateDataQ[y] = new Array();
  for(var q=1;q<5;q+=1){
    stateDataQ[y][q] = new Object();
  }
  for(var st in stateData[y]){
    for(var q in stateDataQ[y]){
      stateDataQ[y][q][st] = (Math.random()*100).toFixed(2) ;
    }
  }
}

$(document).ready(function() {
  // load statelist into select options
  loadStateSelect(Maps,'slState');
});

// load state selection list
function loadStateSelect(slist,slID){
  for(var k in slist){
    var elOptNew = document.createElement('option');
    elOptNew.text = slist[k].code;
    elOptNew.value = slist[k].js;
    var elSel = document.getElementById(slID);
    try {
      elSel.add(elOptNew, null); // standards compliant; doesn't work in IE
    }
    catch(ex) {
      elSel.add(elOptNew); // IE only
    }  
  };
}

var loadTimer;
var loadStatus = "ready";
var loadTimerTotal = 0;
var State = "United States of America";

function selectState(frm){
  if(loadStatus != "ready"){ 
	return; 
  }
  //console.log("loading!");
  var state = frm.slState.options[frm.slState.selectedIndex].text;
  window['newState'] = state;
  if(state == "United States of America"){
    visSlide.reloadUS(us_lowres, stateDataQ,{
    slideControls: "#slidercontrol", slideDiv: "#sliderwrap",
    testOpt: true,
    displayPercentage: true,
    percentRange: [20.1,30.1,45.1],
    width: Size[newState]['width'],
    height: Size[newState]['height'],
    w: Size[newState]['width'],
    h: Size[newState]['height'],
    top: Size[newState]['top'],
    bottom: 20,
    left: Size[newState]['left'],
    scriptID: "visSlideScript", 
    slideTimer: 1000, yearsMargin: 100
      
    });
  } 
  else {
    if(!Maps[state]){
    	return; 
    }
    $('#stateStatus').html('Loading data for '+state+' ...');
    window['GeoCounties'] = undefined;
    loadjscssfile(Maps[state].js,"js");
    loadTimer = setTimeout("checkState()",150);    
    //console.log("Loaded state: "+state);
  }
}

function checkState(){
  newState = window['newState'];
  timerLength = 50000;
  loadTimerTotal += 150;
  if( typeof(window['GeoCounties']) == undefined || !window['GeoCounties'] ){
	if(loadTimerTotal > timerLength){
		$('#stateStatus').html('Timeout loading state map');
		clearTimeout(loadTimer);
	}
    else { 
    	loadTimer = setTimeout("checkState()",150);
    }
    return; 
  }
  else if(loadStatus == 'parsing'){
	if(visSlide.cRange.scaleX != undefined && visSlide.cRange.scaleX > 0){
		//console.log("Map data parsed, cRange set");
		//console.log(visSlide.cRange);
		clearTimeout(loadTimer);
		$('#stateStatus').html('');
		loadStatus = "ready";
	}
	else {
		loadTimer = setTimeout("checkState()",150); 
	}
	return;
  }
  else{
  	// empty 
  }  
  //console.log("Map data loaded.. parsing");
  loadStatus = 'parsing';
  $('#stateStatus').html('Drawing State Map');
  loadTimerTotal = 0;
  //clearTimeout(loadTimer);
  //alert('My new state size: ' + Size[newState]['width']);
  var newDat = createStateData(2008,2009);
  //console.log("Data Generated"); console.log(newDat);
  console.log("State data created.."); console.log(newDat);
  if(visSlide.vis){ visSlide.clearMap(); }
  visSlide.newMap(GeoCounties, newDat, {
    slideControls: "#slidercontrol", slideDiv: "#sliderwrap",
    testOpt: true,
    isState: true,
    displayPercentage: true,
    percentRange: [20.1,30.1,45.1],
    width: Size[newState]['width'],
    height: Size[newState]['height'],
    w: Size[newState]['width'],
    h: Size[newState]['height'],
    top: Size[newState]['top'],
    bottom: 20,
    left: Size[newState]['left'],
    scriptID: "visSlideScript", 
    slideTimer: 1000, yearsMargin: 100
  });
  loadTimer = setTimeout("checkState()",150);
  //loadStatus = "ready";
  //$('#stateStatus').html('');
}

// generate state data
function createStateData(yearmin, yearmax){
  //generate fake test data
  var newDat = new Object;
  if(extrayears){
	yearmin -= extrayears; 
  }
  for(var y = yearmin; y<= yearmax; y+=1){
    newDat[y] = new Array();
    for(var q = 1; q<5; q+=1){
        newDat[y][q] = new Object();
      GeoCounties.forEach(function(zone){
        newDat[y][q][zone.properties.name.toUpperCase()] = (Math.random()*100) ;
      });
    }
  }
  return newDat;
}

function loadjscssfile(filename, filetype){
 if (filetype=="js"){ 
    //if filename is a external JavaScript file
	var fileref=document.createElement('script')
 	fileref.setAttribute("type","text/javascript")
	fileref.setAttribute("src", filename)
 }
 else if (filetype=="css"){ 
    //if filename is an external CSS file
	var fileref=document.createElement("link")
	fileref.setAttribute("rel", "stylesheet")
	fileref.setAttribute("type", "text/css")
	fileref.setAttribute("href", filename)
 }
 if (typeof fileref!="undefined")
  document.getElementsByTagName("head")[0].appendChild(fileref)
}
</script>

    <style type="text/css">
    
#sliderlabels { 
	margin-top: 0em; 
	margin-left: 0; 
}

#fig {
  width: 800px;
  height: 450px;
  margin-left: auto;
  margin-right: auto;
}

#yearSliderHeight {
  height: 10px;
}


.ui-slider-horizontal {
  position: relative;
  text-align: left;
  width: 398px;
}

#yearLabel {
  position: absolute;
  left: 0;
  width: 85;
  text-align: right;
}
/*
#play {
  position: absolute;
  right: 50px;
  cursor: pointer;
}

#fast {
  position: absolute;
  right: 0px;
  cursor: pointer;
}
*/

#sliderwrap { width: 400px; margin-left: auto; margin-right: auto;}
 #slidercontrol { margin-right: auto; width: 150px; float: right; cursor: pointer; margin-top: 1.5em; }
 #map { margin-right: auto; margin-left: auto; height: 500px; }

  </style>
</head>
  
<!--   <div firebugversion="1.5.4" style="display: none;" id="_firebugConsole"></div> -->

<body>
  <div id="center">
    <div id="controls" style="height: 40px;">
    <form name="frmControls">
      Select State:
      <select name="slState" id="slState">
        <option value="USA">United States of America</option>
        
      </select>
      <input type=button name="btState" value="Draw" onClick="selectState(this.parentNode)">

      <input type="button" name="btClear" value="Clear" onClick="visSlide.clearMap()">
      <span id="stateStatus"></span>
    </form>
    </div>
    <div id="fig">
      
      
      <div id="slidercontrol"></div>
      <div id="sliderwrap"></div>
      <div id="map">
      <script type="text/javascript+protovis" id="visSlideScript">

var year = olderWorkerStatistics.endYear;

var w = Size[State]['width'],
    h = Size[State]['height'],
    pTop = Size[State]['top'],
    bottom = 20,
    yearsMargin = 100;

// Find the centroid for each state
us_lowres.forEach(function(c) {
  c.code = c.code.toUpperCase();
  c.centLatLon = centroid(c.borders[0]);
});
var visSlide = new ProtoSliderMap2({w: 800, h: 600});
/*
var visSlide = new ProtoSliderMap2(us_lowres, stateDataQ, {
  slideControls: "#slidercontrol", slideDiv: "#sliderwrap", w: w, h: h,
  legendText: '',
  calculatePercentage: false, 
  percentRange: [20.5,30.5,40.5],
  dataScale: [-1.1,1.1,2.1],
  slideTimer: 1000, yearsMargin: yearsMargin, year: year, top: pTop, bottom: bottom,
  left: Size[State]['left'], right: ''
});
visSlide.groupInit(); */

    </script>
    </div>
  </div>
  </div>
  </body>
</html>